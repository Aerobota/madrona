
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>madrona.staticmap - Static Map Data Layers &mdash; Madrona Decision Support Framework v4.0 documentation</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Madrona Decision Support Framework v4.0 documentation" href="index.html" />
    <link rel="up" title="Core Apps" href="apps.html" />
    <link rel="next" title="madrona.studyregion - The Study Region" href="studyregion.html" />
    <link rel="prev" title="madrona.simplefaq - FAQ system" href="simplefaq.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="studyregion.html" title="madrona.studyregion - The Study Region"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="simplefaq.html" title="madrona.simplefaq - FAQ system"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Madrona Decision Support Framework v4.0 documentation</a> &raquo;</li>
          <li><a href="apps.html" accesskey="U">Core Apps</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="madrona-staticmap-static-map-data-layers">
<span id="staticmap"></span><h1><tt class="docutils literal"><span class="pre">madrona.staticmap</span></tt> -  Static Map Data Layers<a class="headerlink" href="#madrona-staticmap-static-map-data-layers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="customizing-the-mapnik-rendering">
<h2>Customizing the Mapnik Rendering<a class="headerlink" href="#customizing-the-mapnik-rendering" title="Permalink to this headline">¶</a></h2>
<p>Each spatial feature type should provide a classmethod named <cite>mapnik_style</cite> which returns a mapnik Style object for that model. The Style object can contain rules for classification as well as symbolizers for controling the appearance of points, lines, polygons and labels:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Mpa</span><span class="p">(</span><span class="n">PolygonFeature</span><span class="p">):</span>
    <span class="o">....</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">mapnik_style</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">polygon_style</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>

        <span class="n">ps</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">PolygonSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s">&#39;white&#39;</span><span class="p">))</span>
        <span class="n">ps</span><span class="o">.</span><span class="n">fill_opacity</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">LineSymbolizer</span><span class="p">(</span><span class="n">mapnik</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="s">&#39;#555555&#39;</span><span class="p">),</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">ls</span><span class="o">.</span><span class="n">stroke_opacity</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">mapnik</span><span class="o">.</span><span class="n">Rule</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>

        <span class="n">polygon_style</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">polygon_style</span>
</pre></div>
</div>
</div>
<div class="section" id="png-generic-link">
<h2>PNG Generic Link<a class="headerlink" href="#png-generic-link" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">madrona.features</span></tt> app contains a generic link view that leverages staticmap to create PNG Download links for all Features.</p>
</div>
<div class="section" id="default-datasets">
<h2>Default Datasets<a class="headerlink" href="#default-datasets" title="Permalink to this headline">¶</a></h2>
<p>Madrona ships with several example datasets. These default datasets are in ESRI Shapefile format and stored in [[MEDIA_ROOT]]/staticmap/data/.</p>
<ol class="arabic simple">
<li>Land Mask (Based on the &#8220;Global Self-consistent, Hierarchical, High-resolution Shoreline&#8221; dataset and clipped to southern california region - full dataset available from <a class="reference external" href="http://www.evs-islands.com/2007/11/data-global-land-mask-using-vectors.html">EVS Islands</a>.</li>
<li>World ports dataset. (<a class="reference external" href="http://www.people.hofstra.edu/geotrans/eng/media.html">The Geography of Transport Systems</a>)</li>
</ol>
<p>In addition there are django fixtures (ie initial data to populate the database)</p>
<ol class="arabic simple">
<li>study regions</li>
<li>marine protected areas</li>
</ol>
<p>These models contain polygon fields and are represented as postgis geometry fields in the database. Since mapnik can also render data from a postgis data source, these are added to the default map.</p>
</div>
<div class="section" id="adding-datasets">
<h2>Adding Datasets<a class="headerlink" href="#adding-datasets" title="Permalink to this headline">¶</a></h2>
<p>The staticmap application uses <a class="reference external" href="http://mapnik.org">Mapnik</a> to render map images from spatial data. Specifically, we use the <a class="reference external" href="http://trac.mapnik.org/wiki/XMLConfigReference">mapnik XML files</a> to configure the spatial data sources and their styling. If you are unfamiliar with Mapnik, we suggest going over the <a class="reference external" href="http://trac.mapnik.org/wiki/XMLGettingStarted">XML Configuration Tutorial</a> first.</p>
<p>The default mapnik XML config file (&lt;MEDIA_ROOT&gt;/staticmap/socal.xml) is a good starting point. You will need to add two main XML elements in order to set up any additional data for the staticmap</p>
<div class="section" id="layer">
<h3>Layer<a class="headerlink" href="#layer" title="Permalink to this headline">¶</a></h3>
<p>This element defines the path/connection to the data source, the spatial reference system of the input data and the name of the style to use:</p>
<div class="highlight-python"><pre>&lt;Layer name="world" srs="+proj=latlong +datum=WGS84"&gt;
  &lt;StyleName&gt;My Style&lt;/StyleName&gt;
  &lt;Datasource&gt;
    &lt;Parameter name="type"&gt;shape&lt;/Parameter&gt;
    &lt;Parameter name="file"&gt;/path/to/your/world_borders&lt;/Parameter&gt;
  &lt;/Datasource&gt;
&lt;/Layer&gt;</pre>
</div>
</div>
<div class="section" id="style">
<h3>Style<a class="headerlink" href="#style" title="Permalink to this headline">¶</a></h3>
<p>This element defines &#8220;rules&#8221; which determine the colors, symbology, classification and filtering of the data. In the simplest case, you will simply define a single style for all features in the layer:</p>
<div class="highlight-python"><pre>&lt;Style name="My Style"&gt;
  &lt;Rule&gt;
      &lt;PolygonSymbolizer fill="steelblue" /&gt;
      &lt;LineSymbolizer stroke="rgb(5%,5%,5%)" stroke-width="1" /&gt;
  &lt;/Rule&gt;
&lt;/Style&gt;</pre>
</div>
<p>As an alternative to editing xml text files, you can try <a class="reference external" href="http://bitbucket.org/springmeyer/quantumnik/wiki/Home">Quantumnik</a> which allows you to use Quantum GIS to style the layers in a familiar GIS graphic interface and export the map as a mapnik XML.</p>
</div>
<div class="section" id="variable-substitution">
<h3>Variable substitution<a class="headerlink" href="#variable-substitution" title="Permalink to this headline">¶</a></h3>
<p>You may not always know the full path to a local datasource and using relative paths is problematic since deployment details will change the current working directory. To avoid hardcoding paths, you can set use variable substitution to leverage the <tt class="docutils literal"><span class="pre">MEDIA_ROOT</span></tt> setting:</p>
<div class="highlight-python"><pre>&lt;Parameter name="file"&gt;[[MEDIA_ROOT]]/world_borders&lt;/Parameter&gt;</pre>
</div>
<p>staticmap will load the mapfile text and replace <tt class="docutils literal"><span class="pre">[[MEDIA_ROOT]]</span></tt> with settings.MEDIA_ROOT before mapnik loads the mapfile.</p>
</div>
<div class="section" id="note-on-spatial-reference-systems">
<h3>Note on spatial reference systems<a class="headerlink" href="#note-on-spatial-reference-systems" title="Permalink to this headline">¶</a></h3>
<p>The spatial reference system (SRS) of each layer should be explicitly defined using a <a class="reference external" href="http://trac.osgeo.org/proj/wiki/GenParms">proj4 string</a>. Its important to note that this is the SRS of the original data source - it is not necessarily the SRS of the output map. If the SRS defined in the Map element differs from the Layer SRS, mapnik will reproject each Layer to the common SRS of the Map.</p>
</div>
</div>
<div class="section" id="adding-maps-to-the-staticmap-application">
<h2>Adding maps to the staticmap application<a class="headerlink" href="#adding-maps-to-the-staticmap-application" title="Permalink to this headline">¶</a></h2>
<p>If you create a new mapnik xml map, you&#8217;ll need to register it with your django project. First, login to the django admin site and navigate to Home › Staticmap › Map configs › Add map config. Here you will define the short n name of your new map, the initial map dimensions and the path to the xml file.</p>
<p>To access your new map, hit <a class="reference external" href="http://your.domain.com/staticmap/yourmapname">http://your.domain.com/staticmap/yourmapname</a></p>
</div>
<div class="section" id="accessing-maps-by-url">
<h2>Accessing maps by URL<a class="headerlink" href="#accessing-maps-by-url" title="Permalink to this headline">¶</a></h2>
<p>The staticmap can be accessed by url template tags:</p>
<div class="highlight-python"><pre>&lt;img align="top" src="{% url 'staticmap-show' 'default' %}"&gt;</pre>
</div>
<p>The staticmap view also takes several parameters to configure the map</p>
<blockquote>
<div><ul class="simple">
<li><cite>uids</cite> : a comma-seperated list of feature uids. If the feature uid is a feature collection, staticmap will attempt to draw all features contained in that collection.</li>
<li><cite>width</cite> and <cite>height</cite> : Dimensions of the output image (in pixels)</li>
<li><cite>bbox</cite> : a comma-seperated list of four floating point values representing the geographic extent of the output map (ie minx,miny,maxx,maxy)</li>
<li><cite>autozoom</cite> : set to &#8216;True&#8217; if you need the map to automatically set the geographic extent according to the selected features.</li>
<li><cite>show_extent</cite> : set to &#8216;True&#8217; if you need to show a box indicating the extent of selected features. Useful for overview maps.</li>
</ul>
</div></blockquote>
<p>You could incorporate these into a django template as follows:</p>
<div class="highlight-python"><pre>&lt;img align="top" src="{% url 'staticmap-show' 'default' %}?uids={{ feature.uid }}&amp;amp;width=154&amp;amp;height=200&amp;amp;show_extent=True"&gt;</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><tt class="docutils literal"><span class="pre">madrona.staticmap</span></tt> -  Static Map Data Layers</a><ul>
<li><a class="reference internal" href="#customizing-the-mapnik-rendering">Customizing the Mapnik Rendering</a></li>
<li><a class="reference internal" href="#png-generic-link">PNG Generic Link</a></li>
<li><a class="reference internal" href="#default-datasets">Default Datasets</a></li>
<li><a class="reference internal" href="#adding-datasets">Adding Datasets</a><ul>
<li><a class="reference internal" href="#layer">Layer</a></li>
<li><a class="reference internal" href="#style">Style</a></li>
<li><a class="reference internal" href="#variable-substitution">Variable substitution</a></li>
<li><a class="reference internal" href="#note-on-spatial-reference-systems">Note on spatial reference systems</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-maps-to-the-staticmap-application">Adding maps to the staticmap application</a></li>
<li><a class="reference internal" href="#accessing-maps-by-url">Accessing maps by URL</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="simplefaq.html"
                        title="previous chapter"><tt class="docutils literal docutils literal docutils literal"><span class="pre">madrona.simplefaq</span></tt> -  FAQ system</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="studyregion.html"
                        title="next chapter"><tt class="docutils literal"><span class="pre">madrona.studyregion</span></tt> -  The Study Region</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/staticmap.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="studyregion.html" title="madrona.studyregion - The Study Region"
             >next</a> |</li>
        <li class="right" >
          <a href="simplefaq.html" title="madrona.simplefaq - FAQ system"
             >previous</a> |</li>
        <li><a href="index.html">Madrona Decision Support Framework v4.0 documentation</a> &raquo;</li>
          <li><a href="apps.html" >Core Apps</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, MarineMap Consortium, Ecotrust.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>